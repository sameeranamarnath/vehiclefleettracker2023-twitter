"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.Utils = void 0;
const node_path_1 = require("node:path");
const node_fs_1 = __importDefault(require("node:fs"));
const jsonc_parser_1 = require("jsonc-parser");
const node_utils_1 = require("@book000/node-utils");
/**
 * ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
 */
exports.Utils = {
    /**
     * JSONC ã‚’ãƒ‘ãƒ¼ã‚¹ã™ã‚‹
     *
     * @param data ãƒ‘ãƒ¼ã‚¹ã™ã‚‹ JSONC æ–‡å­—åˆ—
     * @returns ãƒ‘ãƒ¼ã‚¹çµæœ
     */
    parseJsonc(data) {
        return (0, jsonc_parser_1.parse)(data);
    },
    /**
     * ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…ã«ã‚ã‚‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªç¾¤ã‚’å–å¾—ã™ã‚‹
     *
     * @param parentDirectory ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’å–å¾—ã™ã‚‹è¦ªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãƒ‘ã‚¹
     * @param baseDirectories ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’å–å¾—ã™ã‚‹å­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãƒ‘ã‚¹ç¾¤
     * @returns ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªç¾¤
     */
    getDirectories(parentDirectory, baseDirectories = []) {
        const baseDirectory = (0, node_path_1.join)(parentDirectory, ...baseDirectories);
        return node_fs_1.default
            .readdirSync(baseDirectory)
            .filter((directory) => !['.', '..'].includes(directory) &&
            node_fs_1.default.statSync(`${baseDirectory}/${directory}`).isDirectory());
    },
    /**
     * ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…ã«ã‚ã‚‹ JSON ãƒ•ã‚¡ã‚¤ãƒ«ç¾¤ã‚’å–å¾—ã™ã‚‹
     *
     * @param parentDirectory ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—ã™ã‚‹è¦ªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãƒ‘ã‚¹
     * @param baseDirectories ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—ã™ã‚‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãƒ‘ã‚¹
     * @returns JSON ãƒ•ã‚¡ã‚¤ãƒ«ç¾¤
     */
    getJSONFiles(parentDirectory, baseDirectories = []) {
        const baseDirectory = (0, node_path_1.join)(parentDirectory, ...baseDirectories);
        return node_fs_1.default
            .readdirSync(baseDirectory)
            .filter((file) => !['.', '..'].includes(file) &&
            node_fs_1.default.statSync((0, node_path_1.join)(baseDirectory, file)).isFile() &&
            file.endsWith('.json'))
            .map((file) => (0, node_path_1.join)(baseDirectory, file));
    },
    /**
     * ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ‡ãƒãƒƒã‚°å‡ºåŠ› JSON ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å…ƒã«ã€ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã”ã¨ã®æƒ…å ±ã‚’ã¾ã¨ã‚ã¦å–å¾—ã™ã‚‹
     *
     * @returns ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã”ã¨ã®æƒ…å ±
     */
    getEndPointResponses(debugOutputDirectory) {
        const logger = node_utils_1.Logger.configure('Utils:getEndPointResponses');
        const results = [];
        for (const type of this.getDirectories(debugOutputDirectory)) {
            for (const name of this.getDirectories(debugOutputDirectory, [type])) {
                for (const method of this.getDirectories(debugOutputDirectory, [
                    type,
                    name,
                ])) {
                    for (const statusCode of this.getDirectories(debugOutputDirectory, [
                        type,
                        name,
                        method,
                    ])) {
                        const paths = this.getJSONFiles(debugOutputDirectory, [
                            type,
                            name,
                            method,
                            statusCode,
                        ]);
                        // 1687602187259.json (unixtime[ms].json)
                        // 30æ—¥ä»¥ä¸Šå‰ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯å‰Šé™¤ã™ã‚‹
                        const now = Date.now();
                        const deleteFiles = paths.filter((path) => {
                            const file = (0, node_path_1.basename)(path);
                            if (!file) {
                                return false;
                            }
                            const unixtime = Number.parseInt(file.split('.')[0]);
                            return now - unixtime > 1000 * 60 * 60 * 24 * 30;
                        });
                        for (const deleteFile of deleteFiles) {
                            logger.info(`ğŸš® Delete: ${deleteFile.replace(debugOutputDirectory, '')}`);
                            node_fs_1.default.unlinkSync(deleteFile);
                        }
                        results.push({
                            type,
                            name,
                            method,
                            statusCode,
                            paths: paths.filter((path) => !deleteFiles.includes(path)),
                        });
                    }
                }
            }
        }
        return results;
    },
    /**
     * ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®å‹å®šç¾©åã‚’å–å¾—ã™ã‚‹
     *
     * @param rawType ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ç¨®åˆ¥ï¼ˆgraphql ã¾ãŸã¯ restï¼‰
     * @param rawName ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®åå‰
     * @param rawMethod ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã® HTTP ãƒ¡ã‚½ãƒƒãƒ‰
     * @param rawStatus ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰
     * @returns å‹å®šç¾©å
     */
    getName(rawType, rawName, rawMethod, rawStatus) {
        const type = rawType.toLocaleLowerCase() === 'graphql'
            ? 'GraphQL'
            : rawType.toLocaleLowerCase() === 'rest'
                ? 'REST'
                : null;
        if (!type) {
            throw new Error(`Invalid type: ${rawType}`);
        }
        const method = this.toCamelCase(rawMethod);
        const name = this.capitalize(rawName);
        const status = rawStatus === null ? '' : rawStatus.startsWith('2') ? 'Success' : 'Error';
        return `${type}${method}${name}${status}Response`;
    },
    /**
     * ã‚­ãƒ£ãƒ¡ãƒ«ã‚±ãƒ¼ã‚¹ã«å¤‰æ›ã™ã‚‹
     *
     * @param string å¤‰æ›ã™ã‚‹æ–‡å­—åˆ—
     * @returns ã‚­ãƒ£ãƒ¡ãƒ«ã‚±ãƒ¼ã‚¹å¤‰æ›å¾Œã®æ–‡å­—åˆ—
     */
    toCamelCase(string) {
        return string.charAt(0).toUpperCase() + string.slice(1).toLowerCase();
    },
    /**
     * å…ˆé ­æ–‡å­—ã‚’å¤§æ–‡å­—ã«å¤‰æ›ã™ã‚‹
     *
     * @param string å¤‰æ›ã™ã‚‹æ–‡å­—åˆ—
     * @returns å¤‰æ›å¾Œã®æ–‡å­—åˆ—
     */
    capitalize(string) {
        return string.charAt(0).toUpperCase() + string.slice(1);
    },
    /**
     * ãƒ•ã‚¡ã‚¤ãƒ«åã‚’å–å¾—ã™ã‚‹
     *
     * @param rawType ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ç¨®åˆ¥ï¼ˆgraphql ã¾ãŸã¯ restï¼‰
     * @param rawName ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®åå‰
     * @param rawMethod ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã® HTTP ãƒ¡ã‚½ãƒƒãƒ‰
     * @param rawStatus ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰
     * @returns ãƒ•ã‚¡ã‚¤ãƒ«å
     */
    getFilename(rawType, rawName, rawMethod, rawStatus) {
        const type = rawType.toLowerCase();
        const method = rawMethod.toLowerCase();
        const name = rawName.replaceAll(/([a-z])([A-Z])/g, '$1-$2').toLowerCase();
        const status = rawStatus.startsWith('2') ? '-success' : '-error';
        return `${type}/${method}/${name}${status}`;
    },
    /**
     * json-schema-to-typescript ã®ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä½œæˆãƒ»å–å¾—ã™ã‚‹
     *
     * @param tsDocument ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«çµæœã®å…ˆé ­ã«è¿½åŠ ã™ã‚‹ tsdoc
     * @returns ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã‚ªãƒ—ã‚·ãƒ§ãƒ³
     */
    getCompileOptions(tsDocument) {
        const compileOptions = {
            bannerComment: '/* eslint-disable @typescript-eslint/ban-types */',
            additionalProperties: false,
            enableConstEnums: true,
            strictIndexSignatures: true,
            style: {
                semi: false,
                singleQuote: true,
            },
            unknownAny: true,
        };
        if (tsDocument) {
            compileOptions.bannerComment = `${compileOptions.bannerComment}\n\n/** ${tsDocument} */`;
        }
        return compileOptions;
    },
};
//# sourceMappingURL=utils.js.map